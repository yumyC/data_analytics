<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…¬åŠ¡å‘˜æ‹›è€ƒ Excel ç­›é€‰ï¼ˆæ–°å¢èŒä½ä»£ç /éƒ¨é—¨ä»£ç /ç”¨äººå¸å±€æœç´¢ï¼‰</title>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select, button { margin-right: 10px; padding: 4px 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; font-size: 13px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    th { background: #f3f3f3; }
    #pagination button { margin: 2px; padding: 4px 8px; }
    #pagination button[disabled] { background: #999; color: #fff; }
  </style>
</head>
<body>

<h2>ğŸ“Š å…¬åŠ¡å‘˜æ‹›è€ƒ & é¢è¯•ä¿¡æ¯ç­›é€‰ï¼ˆæ”¯æŒå¤šåˆ—æœç´¢ï¼‰</h2>

<input type="file" id="fileInput" accept=".xlsx,.xls" />

<hr />

<label>å­¦å†åŒ…å«ï¼š<input type="text" id="degreeFilter" placeholder="å¦‚ï¼šæœ¬ç§‘ / ç¡•å£«"></label>
<label>å­¦å†ä¸åŒ…å«ï¼š<input type="text" id="degreeExcludeFilter" placeholder="å¦‚ï¼šåšå£«"></label>
<label>æ‹›å½•æœºå…³ï¼š<input type="text" id="deptFilter" placeholder="æ¨¡ç³ŠåŒ¹é…"></label>
<label>æœåŠ¡åŸºå±‚é¡¹ç›®å·¥ä½œç»å†ï¼š<input type="text" id="serviceFilter" placeholder="æ¨¡ç³ŠåŒ¹é…"></label>
<label>å¤‡æ³¨ä¸åŒ…å«ï¼š<input type="text" id="remarkExcludeFilter" placeholder="æ’é™¤å…³é”®å­—"></label>
<label>ä¸“ä¸šï¼š<input type="text" id="majorFilter" placeholder="æ¨¡ç³ŠåŒ¹é…"></label>
<label>èŒä½/éƒ¨é—¨/ç”¨äººå¸å±€ï¼š<input type="text" id="codeDeptJobFilter" placeholder="èŒä½ä»£ç /éƒ¨é—¨ä»£ç /ç”¨äººå¸å±€"></label>

<label>æœ€ä½é¢è¯•åˆ†æ•°æ’åºï¼š
  <select id="scoreSort">
    <option value="">ä¸æ’åº</option>
    <option value="asc">å‡åº</option>
    <option value="desc">é™åº</option>
  </select>
</label>

<button onclick="applyFilter()">ç­›é€‰</button>

<div id="info"></div>

<table id="table"></table>
<div id="pagination"></div>

<script>
let rawData = [], filteredData = []
let allColumns = []
const PAGE_SIZE = 50
let currentPage = 1

const table = document.getElementById('table')
const info = document.getElementById('info')
const pagination = document.getElementById('pagination')

const degreeFilter = document.getElementById('degreeFilter')
const degreeExcludeFilter = document.getElementById('degreeExcludeFilter')
const deptFilter = document.getElementById('deptFilter')
const serviceFilter = document.getElementById('serviceFilter')
const remarkExcludeFilter = document.getElementById('remarkExcludeFilter')
const majorFilter = document.getElementById('majorFilter')
const codeDeptJobFilter = document.getElementById('codeDeptJobFilter')
const scoreSort = document.getElementById('scoreSort')

/* è¯»å– Excel */
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0]
  if (!file) return

  const reader = new FileReader()
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result)
    const wb = XLSX.read(data, { type: 'array' })
    const sheet = wb.Sheets[wb.SheetNames[0]]
    rawData = XLSX.utils.sheet_to_json(sheet)
    filteredData = rawData
    currentPage = 1
    allColumns = rawData.length > 0 ? Object.keys(rawData[0]) : []
    info.textContent = `å·²åŠ è½½ ${rawData.length} è¡Œæ•°æ®ï¼Œåˆ—æ•°: ${allColumns.length}`
    renderTable()
  }
  reader.readAsArrayBuffer(file)
})

/* ç­›é€‰ + æ’åº */
function applyFilter() {
  currentPage = 1
  const degree = degreeFilter.value.trim()
  const degreeExclude = degreeExcludeFilter.value.trim()
  const dept = deptFilter.value.trim()
  const service = serviceFilter.value.trim()
  const remarkExclude = remarkExcludeFilter.value.trim()
  const major = majorFilter.value.trim()
  const codeDeptJob = codeDeptJobFilter.value.trim()
  const sort = scoreSort.value

  filteredData = rawData.filter(row => {
    const degreeVal = row['å­¦å†'] || ''
    const remarkVal = row['å¤‡æ³¨'] || ''
    const majorVal = row['ä¸“ä¸š'] || ''
    const codeDeptJobVal = 
      (row['èŒä½ä»£ç '] || '') + '|' + 
      (row['éƒ¨é—¨ä»£ç '] || '') + '|' + 
      (row['ç”¨äººå¸å±€'] || '')
    
    return (
      (!degree || degreeVal.includes(degree)) &&
      (!degreeExclude || !degreeVal.includes(degreeExclude)) &&
      (!dept || (row['æ‹›å½•æœºå…³'] || '').includes(dept)) &&
      (!service || (row['æœåŠ¡åŸºå±‚é¡¹ç›®å·¥ä½œç»å†'] || '').includes(service)) &&
      (!remarkExclude || !remarkVal.includes(remarkExclude)) &&
      (!major || majorVal.includes(major)) &&
      (!codeDeptJob || codeDeptJobVal.includes(codeDeptJob))
    )
  })

  if (sort) {
    filteredData.sort((a, b) => {
      const sa = parseFloat(a['æœ€ä½é¢è¯•åˆ†æ•°']) || Infinity
      const sb = parseFloat(b['æœ€ä½é¢è¯•åˆ†æ•°']) || Infinity
      return sort === 'asc' ? sa - sb : sb - sa
    })
  }

  renderTable()
}

/* é˜²æŠ– */
function debounce(fn, delay = 300) {
  let timer
  return function () {
    clearTimeout(timer)
    timer = setTimeout(fn, delay)
  }
}

const debouncedFilter = debounce(applyFilter)
degreeFilter.oninput = debouncedFilter
degreeExcludeFilter.oninput = debouncedFilter
deptFilter.oninput = debouncedFilter
serviceFilter.oninput = debouncedFilter
remarkExcludeFilter.oninput = debouncedFilter
majorFilter.oninput = debouncedFilter
codeDeptJobFilter.oninput = debouncedFilter
scoreSort.onchange = applyFilter

/* æ¸²æŸ“è¡¨æ ¼ï¼ˆåˆ†é¡µ + æ‰€æœ‰åˆ—ï¼‰ */
function renderTable() {
  table.innerHTML = ''
  pagination.innerHTML = ''

  if (!filteredData.length) {
    table.innerHTML = '<tr><td>æ— æ•°æ®</td></tr>'
    return
  }

  const start = (currentPage - 1) * PAGE_SIZE
  const end = start + PAGE_SIZE
  const pageData = filteredData.slice(start, end)

  const trHead = document.createElement('tr')
  allColumns.forEach(h => {
    const th = document.createElement('th')
    th.textContent = h
    trHead.appendChild(th)
  })
  table.appendChild(trHead)

  const frag = document.createDocumentFragment()
  pageData.forEach(row => {
    const tr = document.createElement('tr')
    allColumns.forEach(h => {
      const td = document.createElement('td')
      td.textContent = row[h] ?? ''
      tr.appendChild(td)
    })
    frag.appendChild(tr)
  })
  table.appendChild(frag)

  renderPagination()
}

/* åˆ†é¡µæŒ‰é’® */
function renderPagination() {
  const pageCount = Math.ceil(filteredData.length / PAGE_SIZE)
  for (let i = 1; i <= pageCount; i++) {
    const btn = document.createElement('button')
    btn.textContent = i
    btn.disabled = i === currentPage
    btn.onclick = () => { currentPage = i; renderTable() }
    pagination.appendChild(btn)
  }
  info.textContent =
    `å…± ${filteredData.length} æ¡ | ç¬¬ ${currentPage}/${pageCount} é¡µ | åˆ—æ•°: ${allColumns.length}`
}
</script>

</body>
</html>
